<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Game with AI</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- FIXED: Latest stable chess.js -->
    <script src="https://cdn.jsdelivr.net/npm/chess.js@1.4.0/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            background: #f0f0f0; 
            font-family: Arial, sans-serif; 
        }
        #board { width: 400px; height: 400px; margin: 20px 0; border: 4px solid #444; background: #eee; }
        .controls { text-align: center; margin: 10px; }
        select, button { padding: 10px; margin: 5px; font-size: 1em; }
        .status { font-size: 1.2em; margin: 10px; }
        #error { color: red; margin: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Chess Game</h1>
    <div id="board"></div>
    <div class="controls">
        <select id="opponent">
            <option value="none">Human vs Human</option>
            <option value="ai" selected>Play against AI (Stockfish)</option>
        </select>
        <select id="playerColor">
            <option value="w" selected>Play as White</option>
            <option value="b">Play as Black</option>
        </select>
        <select id="skillLevel">
            <option value="0">Beginner (0)</option>
            <option value="8">Easy (8)</option>
            <option value="14">Medium (14)</option>
            <option value="18">Hard (18)</option>
            <option value="20" selected>Very Hard (20)</option>
        </select>
        <button onclick="startGame()">Start / New Game</button>
    </div>
    <div class="status" id="status">Press Start to begin</div>
    <div id="error"></div>

    <script>
        console.log('Scripts loaded - checking if Chess is defined:', typeof Chess);

        let board = null;
        let game;
        try {
            game = new Chess();
            console.log('Chess instance created successfully');
        } catch (e) {
            console.error('Chess constructor failed:', e);
        }
        let stockfish = null;
        let aiThinking = false;

        function showError(msg) {
            document.getElementById('error').innerHTML = 'Error: ' + msg;
            console.error('APP ERROR:', msg);
        }

        function initStockfish() {
            try {
                const stockfishUrl = 'https://cdn.jsdelivr.net/npm/stockfish@16.0.0/stockfish.wasm.js';
                const worker = new Worker(stockfishUrl);
                console.log('Stockfish worker started');

                worker.onmessage = function(e) {
                    console.log('Stockfish output:', e.data);
                    if (e.data.startsWith('bestmove')) {
                        const move = e.data.split(' ')[1];
                        if (move && move !== '(none)') {
                            game.move(move);
                            if (board) board.position(game.fen());
                            updateStatus();
                            aiThinking = false;
                        }
                    }
                };

                worker.onerror = (err) => showError('Stockfish failed: ' + (err.message || 'unknown'));

                worker.postMessage('uci');
                worker.postMessage('isready');
                worker.postMessage('ucinewgame');
                return worker;
            } catch (e) {
                showError('Cannot start Stockfish: ' + e.message);
                return null;
            }
        }

        function makeAIMove() {
            if (!game || game.game_over() || aiThinking || !stockfish || !board) return;
            aiThinking = true;
            const skill = document.getElementById('skillLevel').value;
            stockfish.postMessage('setoption name Skill Level value ' + skill);
            stockfish.postMessage('position fen ' + game.fen());
            stockfish.postMessage('go movetime 1500');
            updateStatus();
        }

        function onDrop(source, target) {
            const move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateStatus();
            if (document.getElementById('opponent').value === 'ai' && game.turn() !== document.getElementById('playerColor').value) {
                setTimeout(makeAIMove, 400);
            }
        }

        function updateStatus() {
            let status = '';
            const turnColor = game.turn() === 'w' ? 'White' : 'Black';
            if (game.in_checkmate()) {
                status = `Game over — ${turnColor === 'White' ? 'Black' : 'White'} wins by checkmate!`;
            } else if (game.in_draw()) {
                status = 'Game over — Draw';
            } else {
                status = `${turnColor} to move`;
                if (game.in_check()) status += ' (in check)';
                if (aiThinking) status += ' • AI is thinking...';
            }
            document.getElementById('status').innerHTML = status;
        }

        function startGame() {
            document.getElementById('error').innerHTML = '';
            if (!game) {
                showError('Chess library not loaded - cannot start game');
                return;
            }
            game.reset();
            aiThinking = false;

            console.log('Creating chessboard...');

            const config = {
                draggable: true,
                position: 'start',
                onDrop: onDrop,
                onSnapEnd: () => { if (board) board.position(game.fen()); },
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            };

            if (board) {
                board.destroy();
                board = null;
            }

            try {
                board = Chessboard('board', config);
                console.log('Chessboard initialized OK');
            } catch (err) {
                showError('Chessboard failed: ' + err.message);
                console.error(err);
            }

            const playerColor = document.getElementById('playerColor').value;
            if (board) board.orientation(playerColor === 'w' ? 'white' : 'black');

            if (document.getElementById('opponent').value === 'ai') {
                if (!stockfish) stockfish = initStockfish();
                if (playerColor === 'b' && board) setTimeout(makeAIMove, 1000);
            } else {
                stockfish = null;
            }

            updateStatus();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready - auto-starting game');
            startGame();
        });
    </script>
</body>
</html>
