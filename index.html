<script>
    let board = null;
    let game = null;
    let stockfish = null;
    let aiThinking = false;

    function showError(msg) {
        document.getElementById('error').innerHTML = 'Error: ' + msg;
        console.error('APP ERROR:', msg);
    }

    function initStockfish() {
        try {
            const stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
            
            // FIX: Use a Blob to bypass GitHub Pages "Same-Origin" restriction for Workers
            const blobContent = `importScripts("${stockfishUrl}");`;
            const blob = new Blob([blobContent], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            const worker = new Worker(workerUrl);
            
            worker.onmessage = function(e) {
                if (e.data.startsWith('bestmove')) {
                    const move = e.data.split(' ')[1];
                    if (move && move !== '(none)') {
                        // chess.js 0.10.3 needs { sloppy: true } for engine moves like "e2e4"
                        game.move(move, { sloppy: true });
                        board.position(game.fen());
                        updateStatus();
                        aiThinking = false;
                    }
                }
            };

            worker.postMessage('uci');
            worker.postMessage('isready');
            worker.postMessage('ucinewgame');
            return worker;
        } catch (e) {
            showError('Cannot start Stockfish: ' + e.message);
            return null;
        }
    }

    function makeAIMove() {
        if (!game || game.game_over() || aiThinking || !stockfish) return;
        
        aiThinking = true;
        updateStatus();
        
        const skill = document.getElementById('skillLevel').value;
        stockfish.postMessage('setoption name Skill Level value ' + skill);
        stockfish.postMessage('position fen ' + game.fen());
        stockfish.postMessage('go movetime 1000');
    }

    function onDrop(source, target) {
        const move = game.move({
            from: source,
            to: target,
            promotion: 'q'
        });

        if (move === null) return 'snapback';

        updateStatus();

        if (document.getElementById('opponent').value === 'ai' && !game.game_over()) {
            window.setTimeout(makeAIMove, 250);
        }
    }

    function updateStatus() {
        let status = '';
        const moveColor = game.turn() === 'b' ? 'Black' : 'White';

        if (game.in_checkmate()) {
            status = 'Game over, ' + moveColor + ' is in checkmate.';
        } else if (game.in_draw()) {
            status = 'Game over, drawn position';
        } else {
            status = moveColor + ' to move';
            if (game.in_check()) status += ' (in check)';
            if (aiThinking) status += ' - AI is thinking...';
        }

        document.getElementById('status').innerHTML = status;
    }

    function startGame() {
        document.getElementById('error').innerHTML = '';
        if (typeof Chess === 'undefined') {
            showError("Chess library failed to load.");
            return;
        }

        game = new Chess();
        aiThinking = false;

        const playerColor = document.getElementById('playerColor').value;

        const config = {
            draggable: true,
            position: 'start',
            orientation: playerColor === 'w' ? 'white' : 'black',
            onDrop: onDrop,
            onSnapEnd: function() { board.position(game.fen()); },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };

        if (board) board.destroy();
        board = Chessboard('board', config);

        if (document.getElementById('opponent').value === 'ai') {
            // Only initialize Stockfish once
            if (!stockfish) stockfish = initStockfish();
            
            // If playing as Black, AI moves first
            if (playerColor === 'b') {
                window.setTimeout(makeAIMove, 500);
            }
        }

        updateStatus();
    }

    window.onload = function() {
        startGame();
    };
</script>
